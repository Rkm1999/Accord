<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accord</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#313338">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%235865F2'><path d='M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z'/></svg>">
    <script>
        // Instant redirect if not logged in
        if (!localStorage.getItem('chatUsername')) {
            window.location.replace('/');
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        #messages-container {
            overflow-anchor: auto;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
            background-color: #2B2D31;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #1A1B1E;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #2B2D31;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hidden {
            display: none !important;
        }
        .edited-text {
            color: #949BA4;
            font-size: 11px;
            margin-left: 4px;
        }
        .message-actions {
            opacity: 0;
            transition: opacity 0.2s;
            display: none;
        }
        @media (min-width: 1024px) {
            .message-actions {
                display: flex;
            }
            .message-group:hover .message-actions {
                opacity: 1;
            }
        }
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        .members-sidebar-hidden {
            display: none !important;
        }
        .channel-item {
            transition: all 0.15s ease;
        }
        .channel-item:hover {
            transform: translateX(2px);
        }
        .delete-btn {
            transition: all 0.15s ease;
        }
        .delete-btn:hover {
            transform: scale(1.1);
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes messagePop {
            0% {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .message-group.new-message {
            animation: messagePop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes mentionGlow {
            0%, 100% {
                box-shadow: 0 0 0 rgba(250, 166, 26, 0.1);
            }
            50% {
                box-shadow: 0 0 20px rgba(250, 166, 26, 0.3);
            }
        }

        .mention-highlight {
            animation: mentionGlow 2s ease-in-out;
        }

        @keyframes reactionPop {
            0% {
                transform: scale(0);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }

        .reaction-badge.updated {
            animation: reactionPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #replyBanner.active {
            animation: slideDown 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes channelSwitch {
            0% {
                opacity: 1;
                transform: translateX(0);
            }
            50% {
                opacity: 0;
                transform: translateX(-20px);
            }
            100% {
                opacity: 1;
                transform: translateX(20px);
            }
        }

        .messages-container.switching {
            animation: channelSwitch 0.4s ease-in-out;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
            }
        }

        .online-status-dot {
            animation: pulse 2s infinite;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        .btn-ripple {
            position: relative;
            overflow: hidden;
        }

        .btn-ripple::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, rgba(255, 255, 255, 0.3) 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10);
            opacity: 0;
            transition: transform 0.4s, opacity 0.8s;
        }

        .btn-ripple:active::after {
            transform: scale(0);
            opacity: 0.3;
            transition: 0s;
        }

        @keyframes badgeShake {
            0%, 100% {
                transform: rotate(0deg);
            }
            25% {
                transform: rotate(-5deg);
            }
            75% {
                transform: rotate(5deg);
            }
        }

        .unread-badge.updated {
            animation: badgeShake 0.5s ease-in-out;
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3) translateY(20px);
            }
            50% {
                transform: scale(1.05) translateY(-5px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        #reactionPicker.visible {
            animation: bounceIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        #emojiUploadModal.visible,
        #createChannelModal.visible,
        #searchModal.visible,
        #editModal.visible,
        #profileModal.visible {
            animation: bounceIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes scrollBounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }

        #scroll-bottom-btn.visible {
            animation: scrollBounce 1s ease-in-out infinite;
        }

        @keyframes typingPulse {
            0%, 100% {
                opacity: 0.6;
            }
            50% {
                opacity: 1;
            }
        }

        #typingIndicator.active {
            animation: typingPulse 1.5s ease-in-out infinite;
        }

        .modal-content {
            animation: slideIn 0.2s ease-out;
        }

        #channel-sidebar, #members-sidebar {
            transition: transform 0.3s ease;
        }

        @media (max-width: 1023px) {
            #channel-sidebar, #members-sidebar {
                display: flex !important;
                position: fixed;
                top: 0;
                bottom: 0;
                z-index: 70;
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.25s ease-out;
                will-change: transform, opacity;
                visibility: hidden;
                pointer-events: none;
            }
            #channel-sidebar {
                transform: translateX(-100%);
                opacity: 0;
            }
            #members-sidebar {
                transform: translateX(100%);
                opacity: 0;
            }
            #channel-sidebar.active, #members-sidebar.active {
                visibility: visible;
                pointer-events: auto;
                opacity: 1;
                transform: translateX(0);
            }

            #sidebar-overlay {
                transition: opacity 0.3s ease;
                opacity: 0;
                pointer-events: none;
                display: block !important; /* Always block, just invisible */
                visibility: hidden;
            }

            #sidebar-overlay.visible {
                opacity: 1;
                pointer-events: auto;
                visibility: visible;
            }

            #channel-sidebar.dragging,
            #members-sidebar.dragging,
            #sidebar-overlay.dragging {
                transition: none !important;
                visibility: visible !important;
                pointer-events: auto !important;
            }
        }
        @media (min-width: 1024px) {
            #channel-sidebar, #members-sidebar {
                display: flex !important;
                flex-direction: column !important;
                position: static !important;
                flex-shrink: 0;
                visibility: visible !important;
                opacity: 1 !important;
                transform: none !important;
                pointer-events: auto !important;
                height: 100% !important;
            }
            #channel-sidebar {
                border-right: 1px solid #26272D;
            }
            #members-sidebar {
                border-left: 1px solid #26272D;
            }
        }
        .reaction-badge {
            display: inline-flex;
            align-items: center;
            background: #2b2d31;
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 2px 6px;
            margin-right: 4px;
            margin-top: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.1s;
        }
        .reaction-badge:hover {
            border-color: #5865f2;
            background: #35373c;
        }
        .reaction-badge.active {
            background: rgba(88, 101, 242, 0.15);
            border-color: #5865f2;
        }
        .reaction-count {
            font-size: 12px;
            margin-left: 4px;
            color: #b5bac1;
        }
        .reaction-badge.active .reaction-count {
            color: #5865f2;
        }
        .mention-highlight {
            background: rgba(250, 166, 26, 0.1) !important;
            border-left: 2px solid #faa61a !important;
        }
        .mention-highlight:hover {
            background: rgba(250, 166, 26, 0.12) !important;
        }
        #mentionAutocomplete {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: #232428;
            border: 1px solid #26272D;
            border-radius: 8px 8px 0 0;
            margin-bottom: 2px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
        }
        .autocomplete-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.1s;
        }
        .autocomplete-item:hover, .autocomplete-item.selected {
            background: #35373C;
        }
        .user-mention {
            background: rgba(88, 101, 242, 0.3);
            color: #dee0fc;
            padding: 0 2px;
            border-radius: 3px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.1s;
        }
        .user-mention:hover {
            background: #5865f2;
            color: white;
        }

        /* Swipe-to-reply styles */
        .message-group.swiping {
            transition: transform 0.1s ease-out;
            position: relative;
            z-index: 100;
        }

        .reply-swipe-indicator {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%) translateX(100%);
            background: #5865F2;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            opacity: 0;
            transition: opacity 0.15s ease, transform 0.15s ease;
            pointer-events: none;
            z-index: 50;
        }

        .message-group.swiping .reply-swipe-indicator {
            opacity: 1;
        }

        @media (max-width: 1023px) {
            .reply-swipe-indicator {
                display: flex;
            }
        }

        @media (min-width: 1024px) {
            .reply-swipe-indicator {
                display: none;
            }
        }

        .message-group {
            overflow-x: visible;
            width: 100%;
        }

        .messages-container-wrapper {
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* Ensure all message content wraps */
        .message-group p,
        .message-group div {
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        /* Prevent horizontal scroll on body for mobile and block native swipe navigation */
        html, body {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            overscroll-behavior: none;
        }

        /* Ensure app container doesn't overflow and handle horizontal gestures via JS */
        #app {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            touch-action: pan-y;
            overscroll-behavior: none;
        }

        /* Prevent iOS native context menu on images */
        img {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        /* PWA Update Prompt */
        #pwaUpdatePrompt {
            position: fixed;
            top: 16px;
            left: 16px;
            right: 16px;
            background: #5865F2;
            border-radius: 16px;
            padding: 12px 16px;
            z-index: 300;
            box-shadow: 0 12px 32px rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            animation: slideDownPwa 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* PWA Install Prompt */
        #pwaInstallPrompt {
            position: fixed;
            bottom: 24px;
            left: 16px;
            right: 16px;
            background: #2B2D31;
            border: 1px solid #404249;
            border-radius: 16px;
            padding: 16px;
            z-index: 200;
            box-shadow: 0 12px 32px rgba(0,0,0,0.5);
            display: none;
            flex-direction: column;
            gap: 12px;
            animation: slideUpPwa 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes slideDownPwa {
            from { transform: translateY(-120%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideUpPwa {
            from { transform: translateY(120%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .pwa-icon-container {
            width: 48px;
            height: 48px;
            background: #5865F2;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(88, 101, 242, 0.3);
        }

        @media (min-width: 1024px) {
            #pwaInstallPrompt {
                max-width: 360px;
                left: auto;
                right: 24px;
            }
        }

        /* Send Button Mobile */
        #send-message-btn {
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform: scale(0);
            width: 0;
            opacity: 0;
            overflow: hidden;
        }

        #send-message-btn.visible {
            transform: scale(1);
            width: 32px;
            opacity: 1;
            margin-left: 8px;
        }
        .upload-progress-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(0,0,0,0.3);
            border-radius: 0 0 8px 8px;
            overflow: hidden;
            display: none;
        }
        .upload-progress-bar {
            height: 100%;
            background: #5865F2;
            width: 0%;
            transition: width 0.1s ease;
        }
    </style>
</head>

<body class="bg-[#313338] text-white font-sans overflow-hidden select-none h-screen w-full">

    <div id="app" class="flex h-screen w-full relative overflow-hidden">
        <!-- Drag Drop Overlay -->
        <div id="drag-drop-overlay" class="fixed inset-0 bg-[#5865F2]/20 backdrop-blur-sm z-[70] hidden flex items-center justify-center border-4 border-[#5865F2] border-dashed pointer-events-none">
            <div class="bg-[#313338] rounded-lg p-8 text-center shadow-2xl">
                <i data-lucide="upload-cloud" class="w-16 h-16 text-[#5865F2] mx-auto mb-4"></i>
                <h2 class="text-2xl font-bold text-white mb-2">Drop files to upload</h2>
                <p class="text-[#949BA4]">Images, videos, documents up to 50MB</p>
            </div>
        </div>

        <!-- Sidebar Overlay (Mobile) -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-[60] hidden lg:hidden" onclick="closeAllSidebars()"></div>

        <!-- 1. Channel Sidebar -->
        <div id="channel-sidebar" class="w-60 bg-[#2B2D31] flex flex-col min-w-[240px] left-0 shadow-2xl lg:shadow-none">

            <!-- Server Header -->
            <div class="h-12 px-4 flex items-center justify-between shadow-sm hover:bg-[#35373C] cursor-pointer transition-colors border-b border-[#1f2023]" onclick="closeAllSidebars()">
                <h1 class="font-bold text-[15px] truncate">Accord</h1>
            </div>


            <!-- Sidebar Content -->
            <div class="flex-1 overflow-y-auto custom-scrollbar">
                <!-- Public Channels -->
                <div class="mb-2">
                    <div class="flex items-center justify-between px-2 mb-1 mt-3">
                        <div class="flex items-center">
                            <i data-lucide="chevron-down" class="w-3 h-3 text-[#949BA4] mr-0.5"></i>
                            <span class="text-[11px] font-bold uppercase text-[#949BA4] tracking-wide hover:text-[#dbdee1] cursor-pointer">Channels</span>
                        </div>
                        <button class="text-[#949BA4] hover:text-[#dbdee1] hover:bg-[#35373C] rounded-sm p-0.5 transition-all" onclick="openCreateChannelModal()" title="Create Channel">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <div class="px-2 space-y-0.5" id="channels-container">
                        <!-- Channels injected by JS -->
                    </div>
                </div>

                <!-- Direct Messages -->
                <div class="mb-2">
                    <div class="flex items-center justify-between px-2 mb-1 mt-4">
                        <div class="flex items-center">
                            <i data-lucide="chevron-down" class="w-3 h-3 text-[#949BA4] mr-0.5"></i>
                            <span class="text-[11px] font-bold uppercase text-[#949BA4] tracking-wide hover:text-[#dbdee1] cursor-pointer">Direct Messages</span>
                        </div>
                        <button class="text-[#949BA4] hover:text-[#dbdee1] hover:bg-[#35373C] rounded-sm p-0.5 transition-all" onclick="openStartDMModal()" title="Start DM">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <div class="px-2 space-y-0.5" id="dms-container">
                        <!-- DMs injected by JS -->
                    </div>
                </div>
            </div>

            <!-- User Control Panel -->
            <div class="bg-[#232428] px-2 py-1.5 flex items-center">
                <div class="flex items-center p-1 hover:bg-[#3F4147] rounded cursor-pointer mr-auto group flex-1" onclick="openProfileModal()">
                    <div class="relative mr-2">
                        <div class="w-8 h-8 rounded-full bg-[#5865F2] flex items-center justify-center text-sm font-bold">
                            <span id="user-avatar-initial">U</span>
                        </div>
                        <div class="online-status-dot absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-[#232428] rounded-full"></div>
                    </div>
                    <div class="text-sm overflow-hidden">
                        <div class="font-semibold text-white text-[13px] leading-tight truncate" id="display-username">User</div>
                        <div class="text-[11px] text-[#949BA4] truncate"><span id="current-channel-badge">#general</span></div>
                    </div>
                </div>
                <div class="flex items-center">
                    <button class="p-1.5 hover:bg-[#3F4147] rounded text-[#dbdee1]" onclick="openProfileModal()" title="User Settings">
                        <i data-lucide="settings" class="w-[19px] h-[19px]"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 2. Main Chat Area -->
        <div class="flex-1 flex flex-col min-w-0 bg-[#313338] relative">
            <!-- Unread Banner -->
            <div id="unread-banner" class="absolute top-14 left-4 right-4 bg-[#5865F2]/90 backdrop-blur hover:bg-[#5865F2] text-white px-4 py-2 rounded-t-none rounded-b-md shadow-lg cursor-pointer flex items-center justify-between z-40 transition-all duration-300 transform -translate-y-full opacity-0 hidden" onclick="jumpToUnread()">
                <div class="flex items-center">
                    <i data-lucide="arrow-up" class="w-4 h-4 mr-2 animate-bounce"></i>
                    <span class="font-semibold text-sm">Unread Messages</span>
                </div>
                <span class="text-xs bg-white/20 px-2 py-0.5 rounded">Jump</span>
            </div>

            <!-- Chat Header -->

            <header class="h-12 px-4 flex items-center shadow-sm border-b border-[#26272D] flex-shrink-0 justify-between relative z-50 bg-[#313338]">
                <div class="flex items-center overflow-hidden">
                    <!-- Toggle Channel Button (Mobile) -->
                    <button id="toggle-channels-btn" class="mr-2 hover:text-[#dbdee1] cursor-pointer text-[#B5BAC1] lg:hidden flex items-center justify-center" onmousedown="event.preventDefault()">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                    
                    <i data-lucide="hash" class="text-[#80848E] mr-2 w-6 h-6"></i>
                    <h3 id="header-channel-name" class="font-bold text-white mr-4 whitespace-nowrap">general</h3>
                    <span id="header-topic" class="hidden md:block text-xs text-[#949BA4] truncate border-l border-[#3F4147] pl-4">Start of conversation</span>
                </div>

                <div class="flex items-center space-x-3 text-[#B5BAC1]">
                    <button class="hover:text-[#dbdee1] cursor-pointer text-[#B5BAC1] flex items-center justify-center" onclick="openSearchModal()" title="Search">
                        <i data-lucide="search" class="w-6 h-6"></i>
                    </button>
                    <button id="toggle-members-btn" class="hover:text-[#dbdee1] cursor-pointer text-[#B5BAC1] lg:hidden flex items-center justify-center" onmousedown="event.preventDefault()">
                        <i data-lucide="users" class="w-6 h-6"></i>
                    </button>
                </div>
            </header>



            <!-- Message List -->
            <div class="flex-1 overflow-hidden relative">
                <main id="messages-container" class="h-full overflow-y-auto overflow-x-hidden custom-scrollbar flex flex-col px-4 pt-4 pb-4">
                    <!-- Messages injected by JS -->
                </main>
                
                <!-- Scroll to Bottom Button -->
                <div id="scroll-bottom-btn" class="absolute bottom-4 right-6 bg-[#313338] hover:bg-[#35373C] text-[#B5BAC1] hover:text-[#dbdee1] p-2.5 rounded-full shadow-lg cursor-pointer border border-[#26272D] transition-all duration-200 opacity-0 pointer-events-none z-40 transform translate-y-2" onclick="scrollToBottom()">
                    <i data-lucide="chevron-down" class="w-5 h-5"></i>
                </div>
            </div>

            <!-- Input Area -->
            <div class="px-4 pb-6 bg-[#313338] pt-2 flex-shrink-0">
                <!-- Reply Banner -->
                <div id="replyBanner" class="hidden mb-2 bg-[#232428] rounded-lg px-3 py-2 flex items-center justify-between">
                    <div class="flex items-center flex-1 overflow-hidden">
                        <span class="text-xs text-[#949BA4] mr-2">Replying to</span>
                        <div class="flex items-center gap-2 overflow-hidden">
                            <span class="text-sm font-semibold text-white whitespace-nowrap" id="reply-to-username"></span>
                            <span class="text-xs text-[#949BA4] truncate" id="reply-to-content"></span>
                        </div>
                    </div>
                    <div id="reply-to-media" class="mx-2 hidden">
                        <!-- Media preview injected by JS -->
                    </div>
                    <button type="button" class="text-[#949BA4] hover:text-white transition-colors flex-shrink-0" onclick="cancelReply()">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>


                <!-- Typing Indicator -->
                <div id="typingIndicator" class="h-6 mb-1 flex items-center hidden">
                    <div class="flex space-x-1">
                        <div class="w-1.5 h-1.5 bg-[#dbdee1] rounded-full typing-dot"></div>
                        <div class="w-1.5 h-1.5 bg-[#dbdee1] rounded-full typing-dot"></div>
                        <div class="w-1.5 h-1.5 bg-[#dbdee1] rounded-full typing-dot"></div>
                    </div>
                    <span class="text-xs text-[#dbdee1] font-bold ml-2" id="typing-text">Someone is typing...</span>
                </div>

                <div id="message-input-area" class="bg-[#383A40] rounded-lg px-4 py-2.5 flex items-center relative transition-all">
                    <div id="mentionAutocomplete" class="hidden custom-scrollbar"></div>
                    <button type="button" id="emoji-trigger-btn" class="bg-[#B5BAC1] text-[#313338] rounded-full p-0.5 mr-3 hover:text-white transition-colors flex items-center justify-center" 
                        onmousedown="event.preventDefault()" onclick="toggleReactionPicker(event, null)">
                        <i data-lucide="smile" class="w-4 h-4 font-bold"></i>
                    </button>
                    <input type="file" id="fileInput" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip,.rar" multiple class="hidden">
                    <form id="message-form" class="flex-1 flex items-center">
                        <textarea id="message-input" placeholder="Message #general" rows="1" 
                            class="bg-transparent text-[#dbdee1] w-full focus:outline-none placeholder-[#949BA4] resize-none py-1 leading-[1.375rem] max-h-[50vh] custom-scrollbar"></textarea>
                        <div class="flex items-center text-[#B5BAC1]">
                            <button type="button" class="p-1.5 hover:bg-[#404249] rounded transition-colors" onclick="document.getElementById('fileInput').click()">
                                <i data-lucide="paperclip" class="w-5 h-5"></i>
                            </button>
                            <!-- Send Button (Mobile) -->
                            <button type="submit" id="send-message-btn" class="p-1.5 bg-[#5865F2] hover:bg-[#4752C4] text-white rounded-full transition-all flex items-center justify-center">
                                <i data-lucide="send" class="w-4 h-4 ml-0.5"></i>
                            </button>
                        </div>
                    </form>
                </div>


                <div id="filePreview" class="hidden mt-2 flex flex-wrap gap-2">
                    <!-- File previews injected by JS -->
                </div>
                <!-- Spacer for mobile emoji keyboard -->
                <div id="mobile-emoji-spacer" class="hidden w-full transition-all duration-300"></div>
            </div>
        </div>

        <!-- 3. Members Sidebar -->
        <aside id="members-sidebar" class="w-[240px] bg-[#2B2D31] flex flex-col overflow-y-auto custom-scrollbar p-3 min-w-[240px] right-0 shadow-2xl lg:shadow-none">
            <!-- Members injected by JS -->
        </aside>


    </div>

    <!-- Create Channel Modal -->
    <div id="createChannelModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden" onclick="if(event.target.id === 'createChannelModal') closeCreateChannelModal()">
        <div class="modal-content bg-[#313338] rounded-lg max-w-md w-full mx-4 shadow-2xl border border-[#404249]" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between p-6 border-b border-[#26272D]">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-[#5865F2] rounded-full flex items-center justify-center mr-4">
                        <i data-lucide="hash" class="w-6 h-6 text-white"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-white">Create Channel</h3>
                        <p class="text-sm text-[#949BA4]">Create a new channel to start conversations</p>
                    </div>
                </div>
                <button class="text-[#949BA4] hover:text-white transition-colors p-1 rounded hover:bg-[#404249]" onclick="closeCreateChannelModal()">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-xs font-semibold text-[#B5BAC1] uppercase mb-2">Channel Name</label>
                    <input type="text" id="newChannelName" placeholder="e.g., general, random, announcements" maxlength="30"
                        class="w-full bg-[#1E1F22] text-[#dbdee1] rounded px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-[#5865F2] transition-all border border-transparent focus:border-[#5865F2]"
                        onkeypress="if(event.key === 'Enter') createChannel()">
                </div>
                <div class="flex space-x-3">
                    <button type="button" class="flex-1 bg-transparent hover:bg-[#404249] text-[#949BA4] hover:text-[#dbdee1] py-2.5 rounded transition-colors font-medium" onclick="closeCreateChannelModal()">
                        Cancel
                    </button>
                    <button type="button" id="createChannelBtn" class="btn-ripple flex-1 bg-[#5865F2] hover:bg-[#4752C4] font-semibold py-2.5 rounded transition-colors flex items-center justify-center" onclick="createChannel()">
                        <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                        Create Channel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Start DM Modal -->
    <div id="startDMModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden" onclick="if(event.target.id === 'startDMModal') closeStartDMModal()">
        <div class="modal-content bg-[#313338] rounded-lg max-w-md w-full mx-4 shadow-2xl border border-[#404249]" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between p-4 border-b border-[#26272D]">
                <h3 class="font-bold text-lg text-white">Select a Friend</h3>
                <button class="text-[#949BA4] hover:text-white transition-colors p-1 rounded hover:bg-[#404249]" onclick="closeStartDMModal()">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-2">
                <input type="text" id="dmSearchInput" placeholder="Type the username of a friend" 
                    class="w-full bg-[#1E1F22] text-[#dbdee1] rounded px-3 py-2.5 mb-2 focus:outline-none focus:ring-2 focus:ring-[#5865F2] transition-all border border-transparent">
                <div id="dmUserList" class="max-h-[300px] overflow-y-auto custom-scrollbar space-y-1">
                    <!-- Users injected by JS -->
                </div>
            </div>
            <div class="p-4 border-t border-[#26272D] flex justify-end">
                 <button type="button" class="bg-transparent hover:underline text-[#949BA4] mr-4" onclick="closeStartDMModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="searchModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden" onclick="if(event.target.id === 'searchModal') closeSearchModal()">
        <div class="bg-[#313338] rounded-lg max-w-lg w-full mx-4 shadow-2xl max-h-[80vh] overflow-hidden flex flex-col" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between p-4 border-b border-[#26272D]">
                <h3 class="font-bold text-lg">Search Messages</h3>
                <button class="text-[#949BA4] hover:text-white transition-colors" onclick="closeSearchModal()">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-4 space-y-3">
                <input type="text" id="searchQuery" placeholder="Search text..."
                    class="w-full bg-[#1E1F22] text-[#dbdee1] rounded px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-[#5865F2] transition-all">
                <input type="text" id="searchUsername" placeholder="Search by username..."
                    class="w-full bg-[#1E1F22] text-[#dbdee1] rounded px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-[#5865F2] transition-all">
                <select id="searchChannelId" class="w-full bg-[#1E1F22] text-[#dbdee1] rounded px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-[#5865F2] transition-all">
                    <option value="all">All Channels</option>
                </select>
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="block text-xs text-[#949BA4] mb-1">From</label>
                        <input type="date" id="searchStartDate" class="w-full bg-[#1E1F22] text-[#dbdee1] rounded px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-[#5865F2] transition-all">
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs text-[#949BA4] mb-1">To</label>
                        <input type="date" id="searchEndDate" class="w-full bg-[#1E1F22] text-[#dbdee1] rounded px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-[#5865F2] transition-all">
                    </div>
                </div>
                <button type="button" class="btn-ripple w-full bg-[#5865F2] hover:bg-[#4752C4] font-semibold py-2.5 rounded transition-colors" onclick="performSearch()">
                    Search
                </button>
            </div>
            <div id="searchResults" class="flex-1 overflow-y-auto custom-scrollbar border-t border-[#26272D]">
                <!-- Search results injected by JS -->
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black/95 flex items-center justify-center z-[200] hidden">
        <!-- Overlay for closing when clicking background -->
        <div class="absolute inset-0 z-0" onclick="closeImageModal()"></div>
        
        <!-- Persistent Close Button -->
        <button class="absolute top-6 right-6 text-white/70 hover:text-white transition-colors z-[210] p-2 bg-black/20 rounded-full backdrop-blur-sm" onclick="closeImageModal()">
            <i data-lucide="x" class="w-8 h-8"></i>
        </button>

        <!-- Download Button -->
        <button id="imageModalDownloadBtn" class="absolute top-6 left-6 text-white/70 hover:text-white transition-colors z-[210] p-2 bg-black/20 rounded-full backdrop-blur-sm">
            <i data-lucide="download" class="w-8 h-8"></i>
        </button>
        
        <!-- Image with stopPropagation to prevent closing when clicking/tapping the image itself -->
        <img id="imageModalImg" src="" alt="Full size" class="max-w-[95vw] max-h-[95vh] object-contain relative z-[205] transition-transform duration-200 ease-out cursor-zoom-in" onclick="event.stopPropagation()" oncontextmenu="return false;">
    </div>

    <!-- Reaction Picker Popover (Hidden by default) -->
    <div id="reactionPicker" class="fixed z-[100] hidden bg-[#1E1F22] border border-[#26272D] rounded-lg shadow-xl p-2 flex flex-col w-[220px]">
        <div class="flex flex-wrap gap-1 mb-2 border-b border-[#26272D] pb-2">
            <button class="hover:bg-[#35373C] p-1.5 rounded transition-colors text-xl" onclick="sendReaction('üëç')">üëç</button>
            <button class="hover:bg-[#35373C] p-1.5 rounded transition-colors text-xl" onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
            <button class="hover:bg-[#35373C] p-1.5 rounded transition-colors text-xl" onclick="sendReaction('üòÇ')">üòÇ</button>
            <button class="hover:bg-[#35373C] p-1.5 rounded transition-colors text-xl" onclick="sendReaction('üòÆ')">üòÆ</button>
            <button class="hover:bg-[#35373C] p-1.5 rounded transition-colors text-xl" onclick="sendReaction('üò¢')">üò¢</button>
            <button class="hover:bg-[#35373C] p-1.5 rounded transition-colors text-xl" onclick="sendReaction('üî•')">üî•</button>
            <button class="hover:bg-[#35373C] p-1.5 rounded transition-colors text-xl" onclick="sendReaction('üéâ')">üéâ</button>
            <button class="hover:bg-[#35373C] p-1.5 rounded transition-colors text-xl" onclick="sendReaction('‚úÖ')">‚úÖ</button>
        </div>
        <div class="flex flex-col">
            <div class="flex items-center justify-between mb-1 px-1">
                <span class="text-[10px] font-bold uppercase text-[#949BA4]">Custom Emojis</span>
                <button class="text-[#949BA4] hover:text-white" onclick="openEmojiModal()" title="Upload Custom Emoji">
                    <i data-lucide="plus" class="w-3 h-3"></i>
                </button>
            </div>
            <div id="customEmojisInPicker" class="flex flex-wrap gap-1 max-h-[100px] overflow-y-auto custom-scrollbar">
                <!-- Custom emojis injected here -->
            </div>
        </div>
    </div>

    <!-- Emoji Upload Modal -->
    <div id="emojiUploadModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-[170] hidden" onclick="if(event.target.id === 'emojiUploadModal') closeEmojiModal()">
        <div class="bg-[#313338] rounded-lg max-w-sm w-full mx-4 shadow-2xl border border-[#404249]" onclick="event.stopPropagation()">
            <div class="p-6">
                <h3 class="font-bold text-lg mb-4">Upload Custom Emoji</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-semibold text-[#B5BAC1] uppercase mb-2">Emoji Name</label>
                        <input type="text" id="emojiNameInput" placeholder="e.g., party_blob" 
                            class="w-full bg-[#1E1F22] text-[#dbdee1] rounded px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-[#5865F2]">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-[#B5BAC1] uppercase mb-2">Image File</label>
                        <input type="file" id="emojiFileInput" accept="image/*"
                            class="w-full text-sm text-[#949BA4] file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-[#5865F2] file:text-white hover:file:bg-[#4752C4]">
                    </div>
                    <div class="flex space-x-3 pt-2">
                        <button type="button" class="flex-1 bg-transparent hover:underline text-[#949BA4]" onclick="closeEmojiModal()">Cancel</button>
                        <button type="button" class="flex-1 bg-[#5865F2] hover:bg-[#4752C4] font-semibold py-2 rounded transition-colors" onclick="uploadEmoji()">Upload</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden" onclick="if(event.target.id === 'profileModal') closeProfileModal()">
        <div class="bg-[#313338] rounded-lg max-w-md w-full mx-4 shadow-2xl border border-[#404249]" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="font-bold text-xl">User Settings</h3>
                    <button class="text-[#949BA4] hover:text-white" onclick="closeProfileModal()">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <!-- Avatar Upload -->
                    <div class="flex flex-col items-center">
                        <div class="relative group cursor-pointer" onclick="document.getElementById('avatarInput').click()">
                            <img id="profilePreview" src="https://ui-avatars.com/api/?name=User" class="w-24 h-24 rounded-full object-cover border-4 border-[#1E1F22]">
                            <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <i data-lucide="camera" class="w-8 h-8 text-white"></i>
                            </div>
                        </div>
                        <input type="file" id="avatarInput" accept="image/*" class="hidden" onchange="previewAvatar(event)">
                        <p class="text-xs text-[#949BA4] mt-2">Click to change avatar</p>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-[#B5BAC1] uppercase mb-2">Display Name</label>
                        <input type="text" id="displayNameInput" placeholder="Enter display name" 
                            class="w-full bg-[#1E1F22] text-[#dbdee1] rounded px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-[#5865F2]">
                    </div>

                    <div class="flex items-center justify-between p-3 bg-[#1E1F22] rounded cursor-pointer hover:bg-[#2B2D31] transition-colors" onclick="openNotificationSettingsModal()">
                        <div class="flex items-center gap-3">
                            <i data-lucide="bell" class="w-5 h-5 text-[#B5BAC1]"></i>
                            <div class="flex flex-col">
                                <span class="text-sm font-semibold text-[#dbdee1]">Notification Settings</span>
                                <span class="text-xs text-[#949BA4]">Manage channel alerts</span>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-[#949BA4]"></i>
                    </div>

                    <div class="pt-4 border-t border-[#404249] flex flex-col space-y-3">
                        <div class="bg-[#1E1F22] p-3 rounded border border-dashed border-[#5865F2] hidden" id="newRecoveryKeyContainer">
                            <p class="text-[10px] text-[#949BA4] uppercase font-bold mb-1">New Recovery Key</p>
                            <div class="flex items-center justify-between">
                                <span id="newRecoveryKeyDisplay" class="font-mono font-bold text-white tracking-wider"></span>
                                <button onclick="copyNewRecoveryKey()" class="text-[#B5BAC1] hover:text-white"><i data-lucide="copy" class="w-4 h-4"></i></button>
                            </div>
                        </div>

                        <div class="flex space-x-3">
                            <button type="button" class="flex-1 bg-blue-500/10 hover:bg-blue-500/20 text-[#00A8FC] py-2 rounded transition-colors font-medium text-sm" onclick="regenerateRecoveryKey()">
                                Regenerate Key
                            </button>
                            <button type="button" class="flex-1 bg-red-500/10 hover:bg-red-500/20 text-red-500 py-2 rounded transition-colors font-medium text-sm" onclick="openUserSettings()">
                                Logout
                            </button>
                        </div>
                        <button type="button" class="btn-ripple w-full bg-[#5865F2] hover:bg-[#4752C4] font-semibold py-2.5 rounded transition-colors" onclick="updateProfile()">
                            Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Detail Modal -->
    <div id="userDetailModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-[100] hidden" onclick="if(event.target.id === 'userDetailModal') closeUserDetailModal()">
        <div class="bg-[#1E1F22] rounded-lg max-w-sm w-full shadow-2xl overflow-hidden border border-[#2B2D31]" onclick="event.stopPropagation()">
            <!-- Header Section: Avatar Left, Name Right -->
            <div class="p-6 flex items-center gap-4">
                <div class="relative flex-shrink-0 cursor-pointer hover:opacity-90 transition-opacity" onclick="viewUserDetailAvatar()">
                    <div class="w-20 h-20 rounded-full border-2 border-[#2B2D31] bg-[#313338] relative overflow-hidden">
                        <img id="userDetailAvatar" src="" class="w-full h-full object-cover">
                        <div id="userDetailStatusDot" class="absolute bottom-0.5 right-0.5 w-4 h-4 rounded-full border-[3px] border-[#1E1F22]"></div>
                    </div>
                </div>

                <div class="min-w-0">
                    <h2 id="userDetailDisplayName" class="text-xl font-bold text-white truncate"></h2>
                    <div id="userDetailUsername" class="text-[#B5BAC1] text-sm truncate"></div>
                </div>
            </div>

            <!-- Body Section -->
            <div class="px-4 pb-6">
                <div class="bg-[#2B2D31] rounded-lg p-3 mb-4">
                    <div class="text-[10px] font-bold uppercase text-[#949BA4] mb-1">Status</div>
                    <div id="userDetailStatusText" class="text-sm text-[#dbdee1]"></div>
                </div>

                <button id="userDetailDMBtn" onclick="handleUserDetailDM()" class="w-full bg-[#5865F2] hover:bg-[#4752C4] text-white font-semibold py-2 rounded transition-colors flex items-center justify-center gap-2">
                    <i data-lucide="message-square" class="w-4 h-4"></i>
                    Send Message
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Settings Modal -->
    <div id="notificationSettingsModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-[110] hidden" onclick="if(event.target.id === 'notificationSettingsModal') closeNotificationSettingsModal()">
        <div class="bg-[#313338] rounded-lg max-w-lg w-full mx-4 shadow-2xl border border-[#404249]" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-2">
                        <i data-lucide="bell" class="w-6 h-6 text-[#5865F2]"></i>
                        <h3 class="font-bold text-xl text-white">Notification Settings</h3>
                        <button onclick="showNotificationHelp()" class="text-[#949BA4] hover:text-white transition-colors ml-1" title="What do these mean?">
                            <i data-lucide="help-circle" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <button class="text-[#949BA4] hover:text-white" onclick="closeNotificationSettingsModal()">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <div class="max-h-[60vh] overflow-y-auto custom-scrollbar pr-2 space-y-6">
                    <!-- Global Settings -->
                    <div>
                        <h4 class="text-[10px] font-bold uppercase text-[#949BA4] mb-3 tracking-wider">Global Settings</h4>
                        <div class="flex items-center justify-between p-3 bg-[#2B2D31] rounded-lg border border-[#404249]">
                            <div class="flex flex-col">
                                <span class="text-sm font-semibold text-[#dbdee1]">Push Notifications</span>
                                <span class="text-[11px] text-[#949BA4]">Enable browser notifications for this device</span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="globalPushToggle" class="sr-only peer" onchange="togglePushNotifications(this.checked)">
                                <div class="w-11 h-6 bg-[#404249] peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#22C55E]"></div>
                            </label>
                        </div>
                    </div>

                    <!-- Channel Settings -->
                    <div>
                        <h4 class="text-[10px] font-bold uppercase text-[#949BA4] mb-3 tracking-wider">Channel Overrides</h4>
                        <div id="channelNotificationList" class="space-y-2">
                            <!-- Injected by JS -->
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end">
                    <button onclick="closeNotificationSettingsModal()" class="bg-[#5865F2] hover:bg-[#4752C4] text-white px-6 py-2 rounded font-semibold transition-colors">
                        Done
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PWA Install Prompt -->
    <div id="pwaInstallPrompt">
        <div class="flex items-center gap-4">
            <div class="pwa-icon-container flex-shrink-0">
                <i data-lucide="message-square" class="text-white w-6 h-6"></i>
            </div>
            <div class="flex-1">
                <h4 class="font-bold text-white text-[15px]">Accord Chat</h4>
                <p class="text-[#949BA4] text-xs leading-tight">Install our app for real-time notifications and a faster experience.</p>
            </div>
            <button onclick="closePwaPrompt()" class="text-[#949BA4] hover:text-[#dbdee1] p-1 transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <button id="pwaInstallBtn" class="w-full bg-[#5865F2] hover:bg-[#4752C4] text-white font-bold py-2.5 rounded-lg text-sm transition-all shadow-lg active:scale-[0.98] hidden">
            Install App
        </button>
        <div id="iosInstruction" class="hidden text-[13px] text-[#dbdee1] border-t border-[#404249] pt-3 flex items-center justify-center gap-1.5">
            Tap the <i data-lucide="share" class="w-4 h-4 text-[#00A8FC]"></i> icon and "Add to Home Screen"
        </div>
    </div>

    <!-- PWA Update Prompt -->
    <div id="pwaUpdatePrompt">
        <div class="flex items-center gap-3">
            <i data-lucide="refresh-cw" class="text-white w-5 h-5 animate-spin-slow"></i>
            <span class="text-white text-sm font-semibold">New version available!</span>
        </div>
        <button id="pwaUpdateBtn" class="bg-white text-[#5865F2] px-4 py-1.5 rounded-lg text-sm font-bold shadow hover:bg-[#f0f0f0] transition-colors">
            Update
        </button>
    </div>

    <!-- Mobile Message Actions Modal (Long Press) -->
    <div id="mobileActionModal" class="fixed inset-0 bg-black/60 z-[150] hidden flex flex-col justify-end transition-opacity duration-300 opacity-0" onclick="closeMobileActionModal()">
        <div id="mobileActionContent" class="bg-[#2B2D31] rounded-t-2xl p-4 w-full shadow-2xl transform translate-y-full transition-transform duration-300 ease-out" onclick="event.stopPropagation()">
            <!-- Drag Handle -->
            <div class="w-12 h-1.5 bg-[#4E5058] rounded-full mx-auto mb-6 cursor-grab active:cursor-grabbing touch-none"></div>

            <!-- Quick Reactions -->
            <div class="flex justify-between mb-6 px-2 overflow-x-auto no-scrollbar gap-2">
                <button class="bg-[#1E1F22] hover:bg-[#35373C] w-12 h-12 rounded-full flex items-center justify-center text-2xl active:scale-125 transition-transform" onclick="sendMobileReaction('üëç')">üëç</button>
                <button class="bg-[#1E1F22] hover:bg-[#35373C] w-12 h-12 rounded-full flex items-center justify-center text-2xl active:scale-125 transition-transform" onclick="sendMobileReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                <button class="bg-[#1E1F22] hover:bg-[#35373C] w-12 h-12 rounded-full flex items-center justify-center text-2xl active:scale-125 transition-transform" onclick="sendMobileReaction('üòÇ')">üòÇ</button>
                <button class="bg-[#1E1F22] hover:bg-[#35373C] w-12 h-12 rounded-full flex items-center justify-center text-2xl active:scale-125 transition-transform" onclick="sendMobileReaction('üòÆ')">üòÆ</button>
                <button class="bg-[#1E1F22] hover:bg-[#35373C] w-12 h-12 rounded-full flex items-center justify-center text-2xl active:scale-125 transition-transform" onclick="sendMobileReaction('üò¢')">üò¢</button>
                <button class="bg-[#1E1F22] hover:bg-[#35373C] w-12 h-12 rounded-full flex items-center justify-center text-2xl active:scale-125 transition-transform" onclick="toggleReactionPicker(event, null, true)">
                    <i data-lucide="plus" class="w-6 h-6 text-[#B5BAC1]"></i>
                </button>
            </div>

            <!-- Actions List -->
            <div class="space-y-1">
                <button id="mobile-download-btn" class="w-full flex items-center gap-3 p-4 hover:bg-[#35373C] rounded-xl text-[#dbdee1] font-semibold transition-colors active:bg-[#404249] hidden" onclick="handleMobileAction('download')">
                    <i data-lucide="download" class="w-6 h-6 text-[#B5BAC1]"></i>
                    Download File
                </button>
                <button class="w-full flex items-center gap-3 p-4 hover:bg-[#35373C] rounded-xl text-[#dbdee1] font-semibold transition-colors active:bg-[#404249]" onclick="handleMobileAction('reply')">
                    <i data-lucide="reply" class="w-6 h-6 text-[#B5BAC1]"></i>
                    Reply
                </button>
                <button id="mobile-edit-btn" class="w-full flex items-center gap-3 p-4 hover:bg-[#35373C] rounded-xl text-[#dbdee1] font-semibold transition-colors active:bg-[#404249]" onclick="handleMobileAction('edit')">
                    <i data-lucide="edit-2" class="w-6 h-6 text-[#B5BAC1]"></i>
                    Edit Message
                </button>
                <button class="w-full flex items-center gap-3 p-4 hover:bg-[#35373C] rounded-xl text-[#dbdee1] font-semibold transition-colors active:bg-[#404249]" onclick="handleMobileAction('copy')">
                    <i data-lucide="copy" class="w-6 h-6 text-[#B5BAC1]"></i>
                    Copy Text
                </button>
                <button id="mobile-delete-btn" class="w-full flex items-center gap-3 p-4 hover:bg-[#35373C] rounded-xl text-red-400 font-semibold transition-colors active:bg-red-500/10" onclick="handleMobileAction('delete')">
                    <i data-lucide="trash-2" class="w-6 h-6"></i>
                    Delete Message
                </button>
            </div>

            <!-- Safe Area Bottom -->
            <div class="h-6"></div>
        </div>
    </div>

    <!-- Mobile Emoji Picker Modal -->
    <div id="mobileEmojiModal" class="fixed inset-0 bg-black/60 z-[160] hidden flex flex-col justify-end transition-opacity duration-300 opacity-0" onclick="closeMobileEmojiModal()">
        <div id="mobileEmojiContent" class="bg-[#2B2D31] rounded-t-2xl p-4 w-full shadow-2xl transform translate-y-full transition-transform duration-300 ease-out flex flex-col max-h-[85vh]" onclick="event.stopPropagation()">
            <!-- Drag Handle -->
            <div id="mobile-emoji-handle" class="w-12 h-1.5 bg-[#4E5058] rounded-full mx-auto mb-6 cursor-grab active:cursor-grabbing touch-none"></div>
            
            <div class="flex items-center justify-between mb-4 px-2">
                <h3 class="text-lg font-bold text-white">Select Emoji</h3>
                <button class="text-[#949BA4] hover:text-white p-2" onclick="openEmojiModal()">
                    <i data-lucide="plus" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Scrollable Emoji Body -->
            <div id="mobileEmojiScrollArea" class="flex-1 overflow-y-auto custom-scrollbar px-2 pb-8">
                <!-- Common Emojis -->
                <div class="grid grid-cols-6 gap-2 mb-6">
                    <button class="bg-[#1E1F22] hover:bg-[#35373C] aspect-square rounded-xl flex items-center justify-center text-2xl active:scale-125 transition-transform" style="touch-action: manipulation;" onclick="sendEmojiFromMobile('üëç')">üëç</button>
                    <button class="bg-[#1E1F22] hover:bg-[#35373C] aspect-square rounded-xl flex items-center justify-center text-2xl active:scale-125 transition-transform" style="touch-action: manipulation;" onclick="sendEmojiFromMobile('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                    <button class="bg-[#1E1F22] hover:bg-[#35373C] aspect-square rounded-xl flex items-center justify-center text-2xl active:scale-125 transition-transform" style="touch-action: manipulation;" onclick="sendEmojiFromMobile('üòÇ')">üòÇ</button>
                    <button class="bg-[#1E1F22] hover:bg-[#35373C] aspect-square rounded-xl flex items-center justify-center text-2xl active:scale-125 transition-transform" style="touch-action: manipulation;" onclick="sendEmojiFromMobile('üòÆ')">üòÆ</button>
                    <button class="bg-[#1E1F22] hover:bg-[#35373C] aspect-square rounded-xl flex items-center justify-center text-2xl active:scale-125 transition-transform" style="touch-action: manipulation;" onclick="sendEmojiFromMobile('üò¢')">üò¢</button>
                    <button class="bg-[#1E1F22] hover:bg-[#35373C] aspect-square rounded-xl flex items-center justify-center text-2xl active:scale-125 transition-transform" style="touch-action: manipulation;" onclick="sendEmojiFromMobile('üî•')">üî•</button>
                </div>

                <h4 class="text-[11px] font-bold uppercase text-[#949BA4] mb-3 tracking-wider">Custom Emojis</h4>
                
                <!-- Custom Emojis Grid -->
                <div id="mobileCustomEmojis" class="grid grid-cols-4 sm:grid-cols-6 gap-3">
                    <!-- Injected by JS -->
                </div>
            </div>
        </div>
    </div>

    <script src="chat.js"></script>
    <script type="module" src="firebase-messaging.js"></script>

</body>
</html>